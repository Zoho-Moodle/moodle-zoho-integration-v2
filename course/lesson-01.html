<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lesson 01 â€” FastAPI Backend | Zoho+Moodle Course</title>
  <link rel="stylesheet" href="shared.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css" />
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo"><span>Z+M</span> Integration Course</div>
      <div class="sidebar-subtitle">Ø¯ÙˆØ±Ø© ØªÙƒØ§Ù…Ù„ Zoho + Moodle</div>
    </div>
    <nav class="sidebar-nav" id="sidebar-nav"></nav>
  </aside>

  <main class="main-content">
    <header class="lesson-header">
      <div class="lesson-breadcrumb">Course Home â†’ Lesson 01</div>
      <div class="lesson-number">Lesson 01</div>
      <div class="lesson-title-en">FastAPI Backend Development</div>
      <div class="lesson-title-ar">Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù€ Backend Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… FastAPI</div>
      <div class="lesson-meta">
        <span>ğŸ• ~45 minutes</span>
        <span>ğŸ¯ Intermediate</span>
        <span>ğŸ§© 3 Quiz Questions</span>
      </div>
    </header>

    <div class="lesson-body">

      <div class="objectives">
        <div class="objectives-title">ğŸ¯ Learning Objectives â€” Ø£Ù‡Ø¯Ø§Ù Ø§Ù„Ø¯Ø±Ø³</div>
        <ul>
          <li>Understand how FastAPI handles HTTP methods: GET, POST, PUT, DELETE</li>
          <li>Use path parameters, query parameters, and request bodies</li>
          <li>Implement Pydantic models for request/response validation</li>
          <li>Apply Dependency Injection with <code class="inline">Depends()</code></li>
          <li>Organize endpoints into routers with prefixes</li>
          <li>Understand the full <code class="inline">main.py</code> of this project</li>
        </ul>
      </div>

      <!-- HTTP METHODS -->
      <div class="section">
        <div class="section-title">1. HTTP Methods in FastAPI</div>
        <div class="section-title-ar">Ø£Ù†ÙˆØ§Ø¹ Ø·Ù„Ø¨Ø§Øª HTTP ÙÙŠ FastAPI</div>
        <div class="section-divider"></div>

        <div class="table-wrap">
          <table>
            <thead><tr><th>Decorator</th><th>HTTP Method</th><th>Use Case</th><th>Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</th></tr></thead>
            <tbody>
              <tr><td><code class="inline">@router.get()</code></td><td>GET</td><td>Read data</td><td>Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>
              <tr><td><code class="inline">@router.post()</code></td><td>POST</td><td>Create data / receive webhook</td><td>Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª / Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ webhook</td></tr>
              <tr><td><code class="inline">@router.put()</code></td><td>PUT</td><td>Update (replace entirely)</td><td>ØªØ­Ø¯ÙŠØ« ÙƒØ§Ù…Ù„</td></tr>
              <tr><td><code class="inline">@router.patch()</code></td><td>PATCH</td><td>Update (partial)</td><td>ØªØ­Ø¯ÙŠØ« Ø¬Ø²Ø¦ÙŠ</td></tr>
              <tr><td><code class="inline">@router.delete()</code></td><td>DELETE</td><td>Delete data</td><td>Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>
            </tbody>
          </table>
        </div>

        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <span class="code-filename">backend/app/api/v1/endpoints/students_example.py</span>
            <button class="copy-btn">Copy</button>
          </div>
          <pre><code class="language-python">from fastapi import APIRouter, HTTPException
from pydantic import BaseModel
from typing import Optional

router = APIRouter(prefix="/students", tags=["students"])

# â”€â”€ Pydantic model for request body â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
class StudentCreate(BaseModel):
    """
    Schema for creating a student.
    FastAPI uses this for auto-validation AND auto-documentation.
    Pydantic ÙŠØªØ­Ù‚Ù‚ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø¯Ø®Ù„Ø©
    """
    first_name: str
    last_name: str
    email: str
    phone: Optional[str] = None       # Optional field, defaults to None


class StudentResponse(BaseModel):
    id: int
    first_name: str
    last_name: str
    email: str

    class Config:
        from_attributes = True  # Ø£ÙŠ orm_mode=True ÙÙŠ Pydantic v1


# â”€â”€ GET /students/{student_id} â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@router.get("/{student_id}", response_model=StudentResponse)
def get_student(student_id: int):
    """
    Get a single student by ID.

    Path parameter: student_id is automatically extracted from the URL
    and validated as an integer. If the URL is /students/abc, FastAPI
    returns a 422 error automatically.

    Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„Ù…Ø³Ø§Ø±: student_id ÙŠÙØ³ØªØ®Ø±Ø¬ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
    ÙˆÙŠÙØªØ­Ù‚Ù‚ Ù…Ù†Ù‡ ÙƒØ¹Ø¯Ø¯ ØµØ­ÙŠØ­. Ø¥Ø°Ø§ ÙƒØ§Ù† abc Ù…Ø«Ù„Ø§Ù‹ â†’ Ø®Ø·Ø£ 422 ØªÙ„Ù‚Ø§Ø¦ÙŠ
    """
    # Simulate DB lookup
    if student_id == 1:
        return {"id": 1, "first_name": "Ahmed", "last_name": "Ali", "email": "ahmed@example.com"}
    raise HTTPException(status_code=404, detail=f"Student {student_id} not found")


# â”€â”€ GET /students/?search=ahmed&limit=10 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@router.get("/")
def list_students(search: Optional[str] = None, limit: int = 20, offset: int = 0):
    """
    List students with optional query parameters.

    Query parameters are defined as function arguments with defaults.
    GET /students/?search=ahmed&limit=5&offset=0

    Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… (query params) ØªÙØ¹Ø±ÙÙ‘Ù ÙƒÙ€ arguments Ù…Ø¹ Ù‚ÙŠÙ… Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
    """
    return {
        "results": [],
        "search": search,
        "limit": limit,
        "offset": offset
    }


# â”€â”€ POST /students/ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@router.post("/", status_code=201)
def create_student(student: StudentCreate):
    """
    Create a new student.

    FastAPI automatically:
    1. Parses the JSON request body
    2. Validates all fields against StudentCreate
    3. Returns 422 Validation Error if any field is wrong
    4. Shows this schema in Swagger /docs

    FastAPI ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹:
    1. ÙŠØ­Ù„Ù„ Ø§Ù„Ù€ JSON body
    2. ÙŠØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„
    3. ÙŠÙØ±Ø¬Ø¹ 422 Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    """
    return {
        "status": "created",
        "student": student.dict()
    }</code></pre>
        </div>
      </div>

      <!-- MAIN.PY EXPLAINED -->
      <div class="section">
        <div class="section-title">2. The Real main.py â€” Explained Line by Line</div>
        <div class="section-title-ar">Ø´Ø±Ø­ main.py Ø§Ù„ÙØ¹Ù„ÙŠ Ù…Ù† Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø³Ø·Ø±Ø§Ù‹ Ø¨Ø³Ø·Ø±</div>
        <div class="section-divider"></div>

        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <span class="code-filename">backend/app/main.py</span>
            <button class="copy-btn">Copy</button>
          </div>
          <pre><code class="language-python">from contextlib import asynccontextmanager          # (1) For lifespan
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware  # (2) Cross-origin requests
from app.api.v1.router import router as api_router  # (3) Our main router
from app.core.config import settings                # (4) .env settings
from admin.router import router as admin_router     # (5) Admin panel
from app.infra.db.base import Base, engine          # (6) SQLAlchemy engine
import app.infra.db.models  # noqa â€” (7) IMPORTANT: registers all models
import logging

logger = logging.getLogger(__name__)


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# (8) LIFESPAN â€” runs ONCE when server starts/stops
# ÙŠÙÙ†ÙÙÙ‘Ø° Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„Ø®Ø§Ø¯Ù… ÙˆØ¥ÙŠÙ‚Ø§ÙÙ‡
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@asynccontextmanager
async def lifespan(app: FastAPI):
    # STARTUP: Create all DB tables if they don't exist
    # Ø§Ù„Ø¨Ø¯Ø¡: Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯Ø§ÙˆÙ„ DB Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
    Base.metadata.create_all(bind=engine)
    logger.info("âœ… Database tables created/verified.")
    yield  # â† Application runs here / Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙŠØ¹Ù…Ù„ Ù‡Ù†Ø§
    # SHUTDOWN: Clean up resources here (optional)
    # Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù: ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# (9) CREATE THE FASTAPI APP
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app = FastAPI(
    title=settings.APP_NAME,   # Shown in Swagger UI
    lifespan=lifespan          # Register our startup/shutdown hook
)


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# (10) CORS MIDDLEWARE
# Allows Moodle (on port 443) to call Backend (on port 8001).
# Without this, browsers block cross-origin requests.
# ÙŠØ³Ù…Ø­ Ù„Ù€ Moodle Ø¨Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù€ Backend
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],       # In prod: use your Moodle domain only
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# (11) REGISTER ROUTERS
# All API endpoints live under /api/v1/...
# All admin HTML pages live under /admin/...
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app.include_router(api_router, prefix="/api/v1")
app.include_router(admin_router)

# A simple health check directly on the app (not in any sub-router)
@app.get("/health")
async def root_health():
    return {"status": "healthy", "service": settings.APP_NAME}</code></pre>
        </div>

        <div class="callout info">
          <div class="callout-icon">ğŸ’¡</div>
          <div class="callout-content">
            <div class="callout-title">Why import app.infra.db.models? (Line 7)</div>
            <p>SQLAlchemy's <code class="inline">Base.metadata.create_all()</code> only knows about models that have been <strong>imported</strong> before it's called. If we don't import the models, the tables won't get created â€” even though the model files exist. This single import line pulls in all model classes.</p>
            <div class="callout-ar">SQLAlchemy Ù„Ø§ ÙŠØ¹Ø±Ù Ø¹Ù† Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø² Ø¥Ù„Ø§ Ø¥Ø°Ø§ ØªÙ… <strong>Ø§Ø³ØªÙŠØ±Ø§Ø¯Ù‡Ø§</strong> Ù‚Ø¨Ù„ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ <code class="inline">create_all()</code>. Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± ÙŠØ¶Ù…Ù† Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø² Ù‚Ø¨Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„.</div>
          </div>
        </div>
      </div>

      <!-- ROUTERS -->
      <div class="section">
        <div class="section-title">3. Organizing Endpoints with Routers</div>
        <div class="section-title-ar">ØªÙ†Ø¸ÙŠÙ… Ø§Ù„Ù€ Endpoints Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Routers</div>
        <div class="section-divider"></div>

        <p>Instead of registering all endpoints in <code class="inline">main.py</code>, we use <strong>APIRouter</strong> to split them into logical files, then include them all in <code class="inline">router.py</code>:</p>
        <p style="font-family:'Tajawal',sans-serif;direction:rtl;margin:4px 0 16px;color:var(--gray-600);">Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† ÙˆØ¶Ø¹ ÙƒÙ„ Ø§Ù„Ù€ endpoints ÙÙŠ Ù…Ù„Ù ÙˆØ§Ø­Ø¯ØŒ Ù†Ø³ØªØ®Ø¯Ù… APIRouter Ù„ØªÙ‚Ø³ÙŠÙ…Ù‡Ø§ ÙÙŠ Ù…Ù„ÙØ§Øª Ù…Ù†Ø·Ù‚ÙŠØ©:</p>

        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <span class="code-filename">backend/app/api/v1/router.py</span>
            <button class="copy-btn">Copy</button>
          </div>
          <pre><code class="language-python">from fastapi import APIRouter

# Import each endpoint file's router
from app.api.v1.endpoints.health import router as health_router
from app.api.v1.endpoints.sync_students import router as sync_students_router
from app.api.v1.endpoints.sync_registrations import router as sync_registrations_router
from app.api.v1.endpoints.student_dashboard_webhooks import router as dashboard_router
from app.api.v1.endpoints.debug_enhanced import router as debug_router

# The main router â€” all endpoints in this project live here
router = APIRouter()

# â”€â”€ Register each sub-router â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# tags = group label shown in Swagger /docs
router.include_router(health_router,           tags=["health"])
router.include_router(sync_students_router,    tags=["sync"])
router.include_router(sync_registrations_router, tags=["sync"])

# Webhook handlers: prefix is set inside the endpoint file itself
router.include_router(dashboard_router, prefix="/webhooks/student-dashboard")

router.include_router(debug_router,            tags=["debug"])


# â”€â”€ Final URL paths are stacked â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# main.py:       app.include_router(api_router, prefix="/api/v1")
# router.py:     router.include_router(sync_students_router)
# endpoint file: APIRouter(prefix="/sync")
#                @router.post("/students")
#
# Result:   POST /api/v1/sync/students  âœ…</code></pre>
        </div>
      </div>

      <!-- DEPENDENCY INJECTION -->
      <div class="section">
        <div class="section-title">4. Dependency Injection â€” <code class="inline">Depends()</code></div>
        <div class="section-title-ar">Ø­Ù‚Ù† Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª â€” <code class="inline">Depends()</code></div>
        <div class="section-divider"></div>

        <div class="bilingual">
          <div class="lang-en">
            <span class="lang-badge en">English</span>
            <p><code class="inline">Depends()</code> is FastAPI's dependency injection system. It lets you declare <strong>shared dependencies</strong> (like a database session, or an auth check) once, and inject it into many endpoints cleanly.</p>
            <p style="margin-top:8px;">The most important use in this project: <strong>injecting a DB session into every endpoint that needs it.</strong></p>
          </div>
          <div class="lang-ar">
            <span class="lang-badge ar">Ø¹Ø±Ø¨ÙŠ</span>
            <p><code class="inline">Depends()</code> Ù‡Ùˆ Ù†Ø¸Ø§Ù… Ø­Ù‚Ù† Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª ÙÙŠ FastAPI. ÙŠØ³Ù…Ø­ Ù„Ùƒ Ø¨ØªØ¹Ø±ÙŠÙ <strong>ØªØ¨Ø¹ÙŠØ§Øª Ù…Ø´ØªØ±ÙƒØ©</strong> (Ù…Ø«Ù„ Ø¬Ù„Ø³Ø© DB Ø£Ùˆ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‡ÙˆÙŠØ©) Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©ØŒ ÙˆØ­Ù‚Ù†Ù‡Ø§ ÙÙŠ Ø¹Ø¯Ø© endpoints Ø¨Ø´ÙƒÙ„ Ù†Ø¸ÙŠÙ.</p>
            <p style="margin-top:8px;">Ø£Ù‡Ù… Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙŠ Ù…Ø´Ø±ÙˆØ¹Ù†Ø§: <strong>Ø­Ù‚Ù† Ø¬Ù„Ø³Ø© DB ÙÙŠ ÙƒÙ„ endpoint ÙŠØ­ØªØ§Ø¬Ù‡Ø§.</strong></p>
          </div>
        </div>

        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <span class="code-filename">backend/app/api/v1/endpoints/sync_students.py â€” Actual project code</span>
            <button class="copy-btn">Copy</button>
          </div>
          <pre><code class="language-python">from fastapi import APIRouter, Depends, Request, HTTPException
from sqlalchemy.orm import Session
import logging

from app.infra.db.session import get_db   # Our DB session factory

logger = logging.getLogger(__name__)
router = APIRouter(prefix="/sync")


@router.post("/students", summary="Sync Students from Zoho")
async def sync_students(
    request: Request,
    db: Session = Depends(get_db)   # â† FastAPI injects a DB session automatically!
    #                   ^^^^^^^^^^
    # On every request: creates a new session, yields it, then closes it.
    # ÙÙŠ ÙƒÙ„ Ø·Ù„Ø¨: ÙŠÙ†Ø´Ø¦ Ø¬Ù„Ø³Ø©ØŒ ÙŠÙ…Ø±Ù‘Ø±Ù‡Ø§ØŒ Ø«Ù… ÙŠÙØºÙ„Ù‚Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.
):
    """
    Sync all BTEC_Students from Zoho CRM into the local database.
    POST /api/v1/sync/students
    """
    try:
        body = await request.json()

        # db is now a live SQLAlchemy Session
        # db Ø§Ù„Ø¢Ù† Ø¬Ù„Ø³Ø© SQLAlchemy Ø­ÙŠØ©
        students_data = body.get("data", [])
        count = 0
        for s in students_data:
            # db.merge() = INSERT or UPDATE based on primary key
            # db.merge() = Ø¥Ø¯Ø®Ø§Ù„ Ø£Ùˆ ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
            from app.infra.db.models.student import Student
            student = Student(
                zoho_id=s.get("id"),
                display_name=s.get("Full_Name"),
                academic_email=s.get("Email"),
            )
            db.merge(student)
            count += 1

        db.commit()   # Save all changes / Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
        return {"status": "success", "synced": count}

    except Exception as e:
        db.rollback()  # Undo on error / ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø·Ø£
        logger.error(f"sync_students error: {e}", exc_info=True)
        raise HTTPException(status_code=500, detail=str(e))</code></pre>
        </div>
      </div>

      <!-- PYDANTIC SETTINGS -->
      <div class="section">
        <div class="section-title">5. Configuration with pydantic-settings</div>
        <div class="section-title-ar">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ù† <code class="inline">.env</code></div>
        <div class="section-divider"></div>

        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <span class="code-filename">backend/app/core/config.py â€” Actual project code</span>
            <button class="copy-btn">Copy</button>
          </div>
          <pre><code class="language-python">from pydantic_settings import BaseSettings, SettingsConfigDict
from typing import Optional
import os

# Resolve .env path relative to this file
# Ù†Ø­Ø¯Ø¯ Ù…Ø³Ø§Ø± .env Ø¨Ø§Ù„Ù†Ø³Ø¨Ø© Ù„Ù…ÙˆÙ‚Ø¹ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù
_ENV_FILE = os.path.normpath(
    os.path.join(os.path.dirname(__file__), "..", "..", ".env")
    #           backend/app/core/config.py  â†’  backend/.env
)

class Settings(BaseSettings):
    # All attributes are automatically loaded from .env
    # Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®ØµØ§Ø¦Øµ ØªÙØ­Ù…ÙÙ‘Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† .env

    DATABASE_URL: str = "sqlite:///./moodle_zoho_local.db"
    APP_NAME: str = "Moodle Zoho Integration"
    ENV: str = "development"

    # Moodle
    MOODLE_BASE_URL: Optional[str] = None
    MOODLE_TOKEN: Optional[str] = None
    MOODLE_ENABLED: bool = False

    # Zoho
    ZOHO_CLIENT_ID: Optional[str] = None
    ZOHO_CLIENT_SECRET: Optional[str] = None
    ZOHO_REFRESH_TOKEN: Optional[str] = None
    ZOHO_REGION: str = "com"

    # Webhook
    WEBHOOK_BASE_URL: Optional[str] = None

    # model_config tells pydantic-settings where to find .env
    model_config = SettingsConfigDict(env_file=_ENV_FILE, extra="ignore")


# Create a single instance â€” imported everywhere in the project
# instance ÙˆØ§Ø­Ø¯Ø© ØªÙØ³ØªØ®Ø¯Ù… ÙÙŠ ÙƒÙ„ Ù…ÙƒØ§Ù† ÙÙŠ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
settings = Settings()</code></pre>
        </div>

        <p style="margin-top:16px;">Usage anywhere in the project:</p>
        <div class="code-block">
          <div class="code-header"><span class="code-lang">python</span><button class="copy-btn">Copy</button></div>
          <pre><code class="language-python">from app.core.config import settings

print(settings.MOODLE_BASE_URL)  # â†’ https://your-moodle.com
print(settings.MOODLE_ENABLED)   # â†’ True (bool, auto-converted from "true")
print(settings.ENV)              # â†’ "development"</code></pre>
        </div>
      </div>

      <!-- QUIZ -->
      <div class="section">
        <div class="section-title">ğŸ§ª Lesson 01 Quiz</div>
        <div class="section-divider"></div>

        <div class="quiz-card">
          <div class="quiz-title">â“ Question 1</div>
          <div class="quiz-question">What is the purpose of <code>Depends(get_db)</code> in a FastAPI endpoint?</div>
          <div class="quiz-question-ar">Ù…Ø§ Ø§Ù„ØºØ±Ø¶ Ù…Ù† <code>Depends(get_db)</code> ÙÙŠ FastAPI endpointØŸ</div>
          <ul class="quiz-options">
            <li class="quiz-option"><input type="radio" name="q1" data-correct="false"> It creates a new database every request</li>
            <li class="quiz-option"><input type="radio" name="q1" data-correct="true"> It injects a database session that is automatically closed after the request</li>
            <li class="quiz-option"><input type="radio" name="q1" data-correct="false"> It connects to the database only once at startup</li>
            <li class="quiz-option"><input type="radio" name="q1" data-correct="false"> It locks the database during the request</li>
          </ul>
          <div class="quiz-feedback">âœ… Correct! <code>Depends(get_db)</code> calls the <code>get_db</code> generator function, which creates a new Session, yields it to the endpoint, and then closes it in the <code>finally</code> block â€” even if an exception occurred.</div>
          <button class="quiz-submit">Submit Answer</button>
        </div>

        <div class="quiz-card">
          <div class="quiz-title">â“ Question 2</div>
          <div class="quiz-question">Given <code>app.include_router(api_router, prefix="/api/v1")</code> and <code>APIRouter(prefix="/sync")</code> and <code>@router.post("/students")</code>, what is the full URL?</div>
          <div class="quiz-question-ar">Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ø¯ÙŠÙ†Ø§ prefix="/api/v1" Ø«Ù… prefix="/sync" Ø«Ù… @router.post("/students")ØŒ Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØŸ</div>
          <ul class="quiz-options">
            <li class="quiz-option"><input type="radio" name="q2" data-correct="false"> /students</li>
            <li class="quiz-option"><input type="radio" name="q2" data-correct="false"> /sync/students</li>
            <li class="quiz-option"><input type="radio" name="q2" data-correct="true"> /api/v1/sync/students</li>
            <li class="quiz-option"><input type="radio" name="q2" data-correct="false"> /api/sync/v1/students</li>
          </ul>
          <div class="quiz-feedback">âœ… Correct! URL prefixes stack: /api/v1 (from main.py include_router) + /sync (from APIRouter) + /students (from decorator) = /api/v1/sync/students</div>
          <button class="quiz-submit">Submit Answer</button>
        </div>

        <div class="quiz-card">
          <div class="quiz-title">â“ Question 3</div>
          <div class="quiz-question">What is the purpose of the <code>lifespan</code> function in the FastAPI app?</div>
          <div class="quiz-question-ar">Ù…Ø§ Ø§Ù„ØºØ±Ø¶ Ù…Ù† Ø¯Ø§Ù„Ø© <code>lifespan</code> ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ FastAPIØŸ</div>
          <ul class="quiz-options">
            <li class="quiz-option"><input type="radio" name="q3" data-correct="false"> It defines the API's response schema</li>
            <li class="quiz-option"><input type="radio" name="q3" data-correct="false"> It handles the lifespan of each HTTP request</li>
            <li class="quiz-option"><input type="radio" name="q3" data-correct="true"> It runs code at app startup (before yield) and app shutdown (after yield)</li>
            <li class="quiz-option"><input type="radio" name="q3" data-correct="false"> It sets the timeout for all requests</li>
          </ul>
          <div class="quiz-feedback">âœ… Correct! Code before <code>yield</code> runs at startup (e.g., create DB tables). Code after <code>yield</code> runs at shutdown (cleanup). This replaces the old <code>@app.on_event("startup")</code> pattern.</div>
          <button class="quiz-submit">Submit Answer</button>
        </div>
      </div>

    </div>
    <nav class="lesson-nav" id="lesson-nav"></nav>
  </main>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script>hljs.highlightAll();</script>
<script src="course.js"></script>
<script>initLesson(1);</script>
</body>
</html>
