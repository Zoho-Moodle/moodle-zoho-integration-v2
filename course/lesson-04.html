<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lesson 04 â€” Moodle Plugin | Zoho+Moodle Course</title>
  <link rel="stylesheet" href="shared.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css" />
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo"><span>Z+M</span> Integration Course</div>
      <div class="sidebar-subtitle">Ø¯ÙˆØ±Ø© ØªÙƒØ§Ù…Ù„ Zoho + Moodle</div>
    </div>
    <nav class="sidebar-nav" id="sidebar-nav"></nav>
  </aside>

  <main class="main-content">
    <header class="lesson-header">
      <div class="lesson-breadcrumb">Course Home â†’ Lesson 04</div>
      <div class="lesson-number">Lesson 04</div>
      <div class="lesson-title-en">The Moodle PHP Plugin</div>
      <div class="lesson-title-ar">Ø§Ù„Ù…ÙƒÙˆÙ‘Ù† Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ Ù„Ù€ Moodle Ø¨Ù„ØºØ© PHP</div>
      <div class="lesson-meta">
        <span>ğŸ• ~55 minutes</span>
        <span>ğŸ¯ Advanced</span>
        <span>ğŸ§© 3 Quiz Questions</span>
      </div>
    </header>

    <div class="lesson-body">

      <div class="objectives">
        <div class="objectives-title">ğŸ¯ Learning Objectives â€” Ø£Ù‡Ø¯Ø§Ù Ø§Ù„Ø¯Ø±Ø³</div>
        <ul>
          <li>Understand Moodle plugin architecture and required files</li>
          <li>Declare Web Service functions in <code>db/services.php</code> and <code>db/functions.php</code></li>
          <li>Implement the external PHP class with parameter definitions and execution logic</li>
          <li>Call Moodle Web Service functions from Python using token authentication</li>
          <li>Handle errors and debug plugin issues</li>
        </ul>
      </div>

      <!-- PLUGIN STRUCTURE -->
      <div class="section">
        <div class="section-title">1. Plugin Directory Structure</div>
        <div class="section-title-ar">Ù‡ÙŠÙƒÙ„ Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ù…ÙƒÙˆÙ‘Ù† Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ</div>
        <div class="section-divider"></div>

        <div class="arch-diagram">
          <div class="arch-title">moodle/local/zoho_sync/ â€” Plugin Root</div>
          <div class="arch-item level-0">local/zoho_sync/</div>
          <div class="arch-item level-1">version.php          <span style="color:#94a3b8;font-size:.8rem;">â† Plugin version + metadata (REQUIRED)</span></div>
          <div class="arch-item level-1">lang/</div>
          <div class="arch-item level-2">en/</div>
          <div class="arch-item level-3">local_zoho_sync.php  <span style="color:#94a3b8;font-size:.8rem;">â† English language strings</span></div>
          <div class="arch-item level-1">db/</div>
          <div class="arch-item level-2">services.php         <span style="color:#94a3b8;font-size:.8rem;">â† Declares web service and its functions</span></div>
          <div class="arch-item level-2">functions.php        <span style="color:#94a3b8;font-size:.8rem;">â† Maps function names to PHP classes</span></div>
          <div class="arch-item level-2">upgrade.php          <span style="color:#94a3b8;font-size:.8rem;">â† DB migration steps per version</span></div>
          <div class="arch-item level-1">classes/</div>
          <div class="arch-item level-2">external/</div>
          <div class="arch-item level-3">update_user.php      <span style="color:#94a3b8;font-size:.8rem;">â† PHP external function class</span></div>
          <div class="arch-item level-3">get_user_info.php    <span style="color:#94a3b8;font-size:.8rem;">â† Another external function class</span></div>
        </div>

        <div class="callout info">
          <div class="callout-icon">ğŸ’¡</div>
          <div class="callout-content">
            <div class="callout-title">Plugin Name Convention</div>
            <p>Our plugin is named <strong>local_zoho_sync</strong>. "local" = its type (local plugin, vs block, mod, auth, etc). "zoho_sync" = our unique identifier. This name is used everywhere: folder name, function prefixes, language strings, database tables.</p>
            <div class="callout-ar">Ø§Ø³Ù… Ø§Ù„Ù…ÙƒÙˆÙ‘Ù† <strong>local_zoho_sync</strong>. "local" = Ù†ÙˆØ¹Ù‡ (Ù…ÙƒÙˆÙ‘Ù† Ù…Ø­Ù„ÙŠ). "zoho_sync" = Ù…Ø¹Ø±Ù‘ÙÙ†Ø§ Ø§Ù„ÙØ±ÙŠØ¯. ÙŠÙØ³ØªØ®Ø¯Ù… Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… ÙÙŠ ÙƒÙ„ Ù…ÙƒØ§Ù†: Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù„Ø¯ØŒ Ø¨Ø§Ø¯Ø¦Ø§Øª Ø§Ù„Ø¯ÙˆØ§Ù„ØŒ Ø§Ù„Ø³Ù„Ø§Ø³Ù„ Ø§Ù„Ù†ØµÙŠØ©ØŒ Ø¬Ø¯Ø§ÙˆÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</div>
          </div>
        </div>
      </div>

      <!-- VERSION.PHP -->
      <div class="section">
        <div class="section-title">2. version.php â€” Plugin Identity</div>
        <div class="section-title-ar">Ù…Ù„Ù <code class="inline">version.php</code> â€” Ù‡ÙˆÙŠØ© Ø§Ù„Ù…ÙƒÙˆÙ‘Ù†</div>
        <div class="section-divider"></div>

        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">php</span>
            <span class="code-filename">local/zoho_sync/version.php</span>
            <button class="copy-btn">Copy</button>
          </div>
          <pre><code class="language-php">&lt;?php
/**
 * Version details for local_zoho_sync plugin.
 * Moodle reads this file to know the plugin's version and upgrade needs.
 *
 * Moodle ÙŠÙ‚Ø±Ø£ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù Ù„Ù…Ø¹Ø±ÙØ© Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…ÙƒÙˆÙ‘Ù† ÙˆÙ…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ±Ù‚ÙŠØ©.
 */

defined('MOODLE_INTERNAL') || die();
// The line above prevents direct access to this file.
// Moodle must set MOODLE_INTERNAL constant first.
// ÙŠÙ…Ù†Ø¹ Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù

$plugin->component  = 'local_zoho_sync'; // Must match folder name exactly!
$plugin->version    = 2024120100;         // YYYYMMDD + 2-digit serial (today's date)
$plugin->requires   = 2022041900;         // Moodle 4.0+ required
$plugin->maturity   = MATURITY_STABLE;    // MATURITY_ALPHA | MATURITY_BETA | MATURITY_STABLE
$plugin->release    = '1.0.0';
$plugin->dependencies = [];               // Other plugins this depends on</code></pre>
        </div>
      </div>

      <!-- DB/SERVICES.PHP -->
      <div class="section">
        <div class="section-title">3. db/services.php â€” Declare Web Services</div>
        <div class="section-title-ar">Ù…Ù„Ù <code class="inline">db/services.php</code> â€” Ø¥Ø¹Ù„Ø§Ù† Ø®Ø¯Ù…Ø§Øª Ø§Ù„ÙˆÙŠØ¨</div>
        <div class="section-divider"></div>

        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">php</span>
            <span class="code-filename">local/zoho_sync/db/services.php</span>
            <button class="copy-btn">Copy</button>
          </div>
          <pre><code class="language-php">&lt;?php
/**
 * Declares the web service and which functions belong to it.
 * ÙŠØ¹Ù„Ù† Ø¹Ù† Ø®Ø¯Ù…Ø© Ø§Ù„ÙˆÙŠØ¨ ÙˆØ§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ù†ØªÙ…ÙŠØ© Ø¥Ù„ÙŠÙ‡Ø§
 */

defined('MOODLE_INTERNAL') || die();

/*
 * $functions: Register each individual web service function.
 * Each key is the function name used in API calls.
 * Ø§Ù„Ù…ÙØªØ§Ø­ = Ø§Ø³Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡Ø§Øª API
 */
$functions = [
    'local_zoho_sync_update_user' => [
        'classname'     => 'local_zoho_sync\\external\\update_user',
        'methodname'    => 'execute',
        'description'   => 'Update a Moodle user profile with data from Zoho.',
        'type'          => 'write',    // 'read' or 'write'
        'ajax'          => true,       // Callable from JavaScript (AJAX)
        'loginrequired' => true,       // Requires authenticated token
    ],
    'local_zoho_sync_get_user_info' => [
        'classname'     => 'local_zoho_sync\\external\\get_user_info',
        'methodname'    => 'execute',
        'description'   => 'Get Moodle user info by Zoho ID.',
        'type'          => 'read',
        'ajax'          => true,
        'loginrequired' => true,
    ],
    'local_zoho_sync_enroll_user' => [
        'classname'     => 'local_zoho_sync\\external\\enroll_user',
        'methodname'    => 'execute',
        'description'   => 'Enroll/unenroll a user in a Moodle course.',
        'type'          => 'write',
        'ajax'          => true,
        'loginrequired' => true,
    ],
];

/*
 * $services: Create a named API service that groups the functions above.
 * Clients authenticate with a TOKEN issued to this service.
 * Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙŠØµØ§Ø¯Ù‚ÙˆÙ† Ø¨ØªÙˆÙƒÙ† ØµØ§Ø¯Ø± Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø¯Ù…Ø©
 */
$services = [
    'Zoho Sync Service' => [
        'functions'       => array_keys($functions),  // Include all functions
        'restrictedusers' => 0,       // 0 = any authorised user can use
        'enabled'         => 1,       // Enabled immediately on install
        'shortname'       => 'zoho_sync_ws',
    ],
];</code></pre>
        </div>
      </div>

      <!-- EXTERNAL CLASS -->
      <div class="section">
        <div class="section-title">4. The External Function PHP Class</div>
        <div class="section-title-ar">ÙƒÙ„Ø§Ø³ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© PHP</div>
        <div class="section-divider"></div>

        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">php</span>
            <span class="code-filename">local/zoho_sync/classes/external/update_user.php</span>
            <button class="copy-btn">Copy</button>
          </div>
          <pre><code class="language-php">&lt;?php
namespace local_zoho_sync\external;

use core_external\external_function_parameters;
use core_external\external_single_structure;
use core_external\external_value;
use core_external\external_api;
use PARAM_INT;
use PARAM_TEXT;
use PARAM_ALPHA;

/**
 * Update a Moodle user profile with data from Zoho.
 * ØªØ­Ø¯ÙŠØ« Ù…Ù„Ù Ù…Ø³ØªØ®Ø¯Ù… Moodle Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Zoho
 */
class update_user extends external_api {

    /**
     * Declare what parameters this function accepts.
     * Moodle validates + sanitises input automatically.
     *
     * Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ù…Ù‚Ø¨ÙˆÙ„Ø© â€” Moodle ÙŠØªØ­Ù‚Ù‚ Ù…Ù†Ù‡Ø§ ÙˆÙŠÙØ¹Ù‚Ù‘Ù…Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
     */
    public static function execute_parameters(): external_function_parameters {
        return new external_function_parameters([
            'userid'      => new external_value(PARAM_INT,  'Moodle User ID'),
            'firstname'   => new external_value(PARAM_TEXT, 'First name',   VALUE_OPTIONAL, null),
            'lastname'    => new external_value(PARAM_TEXT, 'Last name',    VALUE_OPTIONAL, null),
            'email'       => new external_value(PARAM_TEXT, 'Email',        VALUE_OPTIONAL, null),
            'phone'       => new external_value(PARAM_TEXT, 'Phone number', VALUE_OPTIONAL, null),
            'city'        => new external_value(PARAM_TEXT, 'City',         VALUE_OPTIONAL, null),
            'country'     => new external_value(PARAM_ALPHA,'Country code', VALUE_OPTIONAL, null),
            'profileimageurl' => new external_value(PARAM_TEXT, 'Photo URL', VALUE_OPTIONAL, null),
        ]);
    }

    /**
     * The actual function that runs when the WS is called.
     * Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„ÙØ¹Ù„ÙŠØ© Ø§Ù„ØªÙŠ ØªÙÙ†ÙÙÙ‘Ø° Ø¹Ù†Ø¯ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø®Ø¯Ù…Ø© Ø§Ù„ÙˆÙŠØ¨
     */
    public static function execute(
        int    $userid,
        ?string $firstname = null,
        ?string $lastname  = null,
        ?string $email     = null,
        ?string $phone     = null,
        ?string $city      = null,
        ?string $country   = null,
        ?string $profileimageurl = null
    ): array {
        global $DB, $CFG;
        require_once($CFG->dirroot . '/user/lib.php');

        // Validate parameters (Moodle's requirement)
        self::validate_parameters(self::execute_parameters(), [
            'userid'      => $userid,
            'firstname'   => $firstname,
            'lastname'    => $lastname,
            'email'       => $email,
            'phone'       => $phone,
            'city'        => $city,
            'country'     => $country,
            'profileimageurl' => $profileimageurl,
        ]);

        // Check user exists
        $user = $DB->get_record('user', ['id' => $userid], '*', MUST_EXIST);

        // Build update object â€” only update provided fields
        $update = (object)['id' => $userid];
        if ($firstname !== null) $update->firstname = $firstname;
        if ($lastname  !== null) $update->lastname  = $lastname;
        if ($email     !== null) $update->email     = $email;
        if ($phone     !== null) $update->phone1    = $phone;
        if ($city      !== null) $update->city      = $city;
        if ($country   !== null) $update->country   = $country;

        user_update_user($update, false, false);

        // Handle profile photo upload
        if ($profileimageurl) {
            // Download and set as profile image
            require_once($CFG->dirroot . '/lib/filelib.php');
            $userid_context = \context_user::instance($userid);
            $imagecontent   = file_get_contents($profileimageurl);
            if ($imagecontent !== false) {
                $tempfile = tempnam(sys_get_temp_dir(), 'zoho_photo_');
                file_put_contents($tempfile, $imagecontent);
                process_new_icon($userid_context, 'user', 'icon', 0, $tempfile);
                @unlink($tempfile);
            }
        }

        return [
            'success' => true,
            'userid'  => $userid,
            'message' => 'User updated successfully',
        ];
    }

    /**
     * Declare what the function returns.
     * Ø¥Ø¹Ù„Ø§Ù† Ù…Ø§ ØªÙØ¹ÙŠØ¯Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø©
     */
    public static function execute_returns(): external_single_structure {
        return new external_single_structure([
            'success' => new external_value(PARAM_BOOL, 'Was update successful?'),
            'userid'  => new external_value(PARAM_INT,  'Updated user ID'),
            'message' => new external_value(PARAM_TEXT, 'Status message'),
        ]);
    }
}</code></pre>
        </div>
      </div>

      <!-- CALLING FROM PYTHON -->
      <div class="section">
        <div class="section-title">5. Calling Moodle WS from Python</div>
        <div class="section-title-ar">Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø®Ø¯Ù…Ø© Moodle Ù…Ù† Python</div>
        <div class="section-divider"></div>

        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <span class="code-filename">backend/app/integrations/moodle/client.py</span>
            <button class="copy-btn">Copy</button>
          </div>
          <pre><code class="language-python">import httpx
from app.core.config import settings


def call_moodle_ws(function_name: str, params: dict) -> dict:
    """
    Call any Moodle Web Service function.

    Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø£ÙŠ Ø¯Ø§Ù„Ø© Ù…Ù† Ø®Ø¯Ù…Ø§Øª Ø§Ù„ÙˆÙŠØ¨ ÙÙŠ Moodle.

    Args:
        function_name: e.g. "local_zoho_sync_update_user"
        params:        Dict of parameters matching the PHP execute() signature

    Returns:
        Parsed JSON response from Moodle
    """
    url = f"{settings.MOODLE_URL}/webservice/rest/server.php"

    payload = {
        "wstoken":       settings.MOODLE_TOKEN,       # Auth token from Moodle admin
        "wsfunction":    function_name,                # PHP function name
        "moodlewsrestformat": "json",                  # Always use JSON format
        **params,                                       # All function parameters
    }

    response = httpx.post(url, data=payload, timeout=30)
    response.raise_for_status()

    result = response.json()

    # Moodle returns errors inside the JSON, not via HTTP status codes!
    # Moodle ÙŠÙØ¹ÙŠØ¯ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø¯Ø§Ø®Ù„ JSON ÙˆÙ„ÙŠØ³ Ø¹Ø¨Ø± Ø±Ù…ÙˆØ² Ø­Ø§Ù„Ø© HTTP
    if isinstance(result, dict) and "exception" in result:
        raise RuntimeError(
            f"Moodle WS error for {function_name}: "
            f"{result.get('message', 'Unknown error')} "
            f"(errorcode: {result.get('errorcode', 'N/A')})"
        )

    return result


# â”€â”€ Helper wrappers for common operations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def moodle_update_user(userid: int, **fields) -> dict:
    return call_moodle_ws("local_zoho_sync_update_user",
                          {"userid": userid, **fields})


def moodle_enroll_user(userid: int, courseid: int, roleid: int = 5) -> dict:
    """roleid=5 is the default 'student' role in most Moodle installations."""
    return call_moodle_ws("local_zoho_sync_enroll_user", {
        "userid":   userid,
        "courseid": courseid,
        "roleid":   roleid,
    })


def moodle_get_user(userid: int) -> dict:
    return call_moodle_ws("local_zoho_sync_get_user_info", {"userid": userid})</code></pre>
        </div>

        <div class="callout warning">
          <div class="callout-icon">âš ï¸</div>
          <div class="callout-content">
            <div class="callout-title">Moodle Errors Are Hidden in 200 OK Responses</div>
            <p>Even when a Moodle WS call fails (wrong token, wrong parameter, missing capability), Moodle returns HTTP 200. The error is inside the JSON body as an <code>"exception"</code> key. Always check for it â€” don't assume a 200 OK means success.</p>
            <div class="callout-ar">Ø­ØªÙ‰ Ø¹Ù†Ø¯ ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ØŒ ÙŠÙØ¹ÙŠØ¯ Moodle HTTP 200. Ø§Ù„Ø®Ø·Ø£ ÙŠÙƒÙˆÙ† Ø¯Ø§Ø®Ù„ JSON ÙƒÙ…ÙØªØ§Ø­ <code>"exception"</code>. ØªØ­Ù‚Ù‚ Ù…Ù†Ù‡ Ø¯Ø§Ø¦Ù…Ø§Ù‹.</div>
          </div>
        </div>
      </div>

      <!-- QUIZ -->
      <div class="section">
        <div class="section-title">ğŸ§ª Lesson 04 Quiz</div>
        <div class="section-divider"></div>

        <div class="quiz-card">
          <div class="quiz-title">â“ Question 1</div>
          <div class="quiz-question">In a Moodle plugin, what is the purpose of <code>db/services.php</code>?</div>
          <div class="quiz-question-ar">Ù…Ø§ Ø§Ù„ØºØ±Ø¶ Ù…Ù† Ù…Ù„Ù <code>db/services.php</code> ÙÙŠ Ù…ÙƒÙˆÙ‘Ù† MoodleØŸ</div>
          <ul class="quiz-options">
            <li class="quiz-option"><input type="radio" name="q1" data-correct="false"> It stores SQL queries used by the plugin</li>
            <li class="quiz-option"><input type="radio" name="q1" data-correct="false"> It defines database table schemas</li>
            <li class="quiz-option"><input type="radio" name="q1" data-correct="true"> It declares web service functions and creates named API services</li>
            <li class="quiz-option"><input type="radio" name="q1" data-correct="false"> It is the PHP class that handles the actual logic</li>
          </ul>
          <div class="quiz-feedback">âœ… Correct! <code>db/services.php</code> tells Moodle: "these are my web service functions and this is the named service that groups them". Without it, Moodle doesn't know the functions exist.</div>
          <button class="quiz-submit">Submit Answer</button>
        </div>

        <div class="quiz-card">
          <div class="quiz-title">â“ Question 2</div>
          <div class="quiz-question">Why must <code>self::validate_parameters()</code> be called at the start of every external function's <code>execute()</code> method?</div>
          <div class="quiz-question-ar">Ù„Ù…Ø§Ø°Ø§ ÙŠØ¬Ø¨ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ <code>self::validate_parameters()</code> ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© ÙƒÙ„ Ø¯Ø§Ù„Ø© <code>execute()</code>ØŸ</div>
          <ul class="quiz-options">
            <li class="quiz-option"><input type="radio" name="q2" data-correct="false"> To log the function call to the Moodle event log</li>
            <li class="quiz-option"><input type="radio" name="q2" data-correct="true"> Moodle requires it to sanitise inputs and enforce the declared parameter types and constraints</li>
            <li class="quiz-option"><input type="radio" name="q2" data-correct="false"> It automatically checks user permissions</li>
            <li class="quiz-option"><input type="radio" name="q2" data-correct="false"> It converts parameters to the correct PHP types</li>
          </ul>
          <div class="quiz-feedback">âœ… Correct! Moodle enforces a strict contract: parameters must be validated against the <code>execute_parameters()</code> declaration. This provides automatic input sanitisation (using PARAM_* constants) and type enforcement.</div>
          <button class="quiz-submit">Submit Answer</button>
        </div>

        <div class="quiz-card">
          <div class="quiz-title">â“ Question 3</div>
          <div class="quiz-question">Our Python <code>call_moodle_ws()</code> function checks for an <code>"exception"</code> key in the response even when the HTTP status is 200. Why?</div>
          <div class="quiz-question-ar">Ù„Ù…Ø§Ø°Ø§ ÙŠØªØ­Ù‚Ù‚ <code>call_moodle_ws()</code> Ù…Ù† Ù…ÙØªØ§Ø­ <code>"exception"</code> Ø­ØªÙ‰ Ø¹Ù†Ø¯ HTTP 200ØŸ</div>
          <ul class="quiz-options">
            <li class="quiz-option"><input type="radio" name="q3" data-correct="false"> Moodle returns 200 only for partial successes</li>
            <li class="quiz-option"><input type="radio" name="q3" data-correct="false"> It's a bug in Moodle's API implementation</li>
            <li class="quiz-option"><input type="radio" name="q3" data-correct="true"> Moodle always returns HTTP 200; actual errors are reported in the JSON body via the <code>"exception"</code> key</li>
            <li class="quiz-option"><input type="radio" name="q3" data-correct="false"> To handle Moodle maintenance mode responses</li>
          </ul>
          <div class="quiz-feedback">âœ… Correct! Moodle's Web Service REST API always returns HTTP 200. Errors like wrong token, missing capability, or invalid data are returned as <code>{"exception": "...", "errorcode": "...", "message": "..."}</code> inside the response body.</div>
          <button class="quiz-submit">Submit Answer</button>
        </div>

      </div>
    </div>
    <nav class="lesson-nav" id="lesson-nav"></nav>
  </main>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script>hljs.highlightAll();</script>
<script src="course.js"></script>
<script>initLesson(4);</script>
</body>
</html>
