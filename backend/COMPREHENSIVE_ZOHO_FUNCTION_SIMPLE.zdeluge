// ============================================================================
// ğŸ¯ Ù†Ø³Ø®Ø© Ù…Ø®ØªØµØ±Ø© ÙˆØ¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… - Ù†Ø³Ø® ÙˆØ§Ù„ØµÙ‚ Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ Zoho
// ============================================================================

// ğŸ‘‰ Ø§Ø³ØªØ¨Ø¯Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ø«Ù„Ø§Ø«Ø© ÙÙ‚Ø· Ù‚Ø¨Ù„ Ø§Ù„ØªØ´ØºÙŠÙ„:
string API_TOKEN = "Zoho CRM API Token Ù‡Ù†Ø§";
string WEBHOOK_URL = "https://your-ngrok-url.ngrok-free.dev/v1/debug/webhook/zoho";
string ORG_ID = "org ID Ù‡Ù†Ø§"; // Ø§Ø®ØªÙŠØ§Ø±ÙŠ

// ============================================================================

map<string, object> processField(object val, string type) {
    if (val == null) return {"value": null, "type": type};
    
    string type_lower = type.toLowerCase();
    
    // Ù†ØµÙˆØµ
    if (type_lower.contains("text") || type_lower.contains("string")) {
        return {"value": val.toString(), "type": "text"};
    }
    
    // Ø£Ø±Ù‚Ø§Ù…
    if (type_lower.contains("number") || type_lower.contains("currency") || type_lower.contains("decimal")) {
        return {"value": val.toString().toNumber(), "type": "number", "is_currency": type_lower.contains("currency")};
    }
    
    // ØªØ§Ø±ÙŠØ® ÙÙ‚Ø·
    if (type_lower.contains("date") && !type_lower.contains("datetime")) {
        return {"value": val.toString(), "type": "date"};
    }
    
    // ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª
    if (type_lower.contains("datetime") || type_lower.contains("timestamp")) {
        return {"value": val.toString(), "type": "datetime"};
    }
    
    // Ù‚Ø§Ø¦Ù…Ø© Ø§Ø®ØªÙŠØ§Ø±
    if (type_lower.contains("picklist") || type_lower.contains("multiselect")) {
        list items = list();
        if (val.getDataType() != "list") {
            items.add(val.toString());
        } else {
            for each v in val { items.add(v.toString()); }
        }
        return {"value": items, "type": "picklist", "count": items.size()};
    }
    
    // Ø±Ø¨Ø· Ø¨Ø³ÙŠØ·
    if (type_lower.contains("lookup") && !type_lower.contains("multi")) {
        if (val.getDataType() == "map") {
            return {"value": val, "type": "lookup"};
        }
        return {"value": {"id": val.toString()}, "type": "lookup"};
    }
    
    // Ø±Ø¨Ø· Ù…ØªØ¹Ø¯Ø¯
    if (type_lower.contains("lookup") && type_lower.contains("multi")) {
        list lookups = list();
        if (val.getDataType() == "list") {
            for each item in val {
                if (item.getDataType() == "map") {
                    lookups.add(item);
                } else {
                    lookups.add({"id": item.toString()});
                }
            }
        }
        return {"value": lookups, "type": "multi_lookup", "count": lookups.size()};
    }
    
    // Ù…Ù†Ø·Ù‚ÙŠ
    if (type_lower.contains("boolean") || type_lower.contains("checkbox")) {
        return {"value": val.getDataType() == "boolean" ? val : val.toString().equalsIgnoreCase("true"), "type": "boolean"};
    }
    
    // Ø¨Ø±ÙŠØ¯
    if (type_lower.contains("email")) {
        return {"value": val.toString(), "type": "email"};
    }
    
    // Ù‡Ø§ØªÙ
    if (type_lower.contains("phone")) {
        return {"value": val.toString(), "type": "phone"};
    }
    
    // Ù…Ù„ÙØ§Øª
    if (type_lower.contains("file") || type_lower.contains("attachment")) {
        return {"value": val.getDataType() == "list" ? val : list(val), "type": "attachment"};
    }
    
    return {"value": val, "type": "other", "data_type": val.getDataType()};
}

map<string, object> fetchModule(string module_name) {
    info "ğŸ” Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨: " + module_name;
    
    map result = {"module": module_name, "records": list(), "error": null, "status": "processing"};
    
    try {
        map headers = {"Authorization": "Bearer " + API_TOKEN, "Content-Type": "application/json"};
        
        // Ø¬Ù„Ø¨ metadata
        string meta_url = "https://www.zohoapis.com/crm/v2/" + module_name + "/metadata";
        map metadata = invokeurl[url: meta_url, type: "GET", headers: headers];
        list fields = metadata.get("fields");
        
        // Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
        string data_url = "https://www.zohoapis.com/crm/v2/" + module_name + "?fields=*&page=1&per_page=100";
        map data_resp = invokeurl[url: data_url, type: "GET", headers: headers];
        list records = data_resp.get("data");
        
        info "ğŸ“Š " + module_name + ": " + records.size() + " Ø³Ø¬Ù„Ø§ØªØŒ " + fields.size() + " Ø­Ù‚ÙˆÙ„";
        
        list processed = list();
        for each record in records {
            map rec = {"id": record.get("id"), "fields": map()};
            map rec_fields = rec.get("fields");
            
            for each field in fields {
                string fname = field.get("api_name");
                string ftype = field.get("data_type");
                object fval = record.get(fname);
                
                rec_fields.put(fname, {
                    "label": field.get("label"),
                    "type": ftype,
                    "processed": processField(fval, ftype)
                });
            }
            
            processed.add(rec);
        }
        
        result.put("records", processed);
        result.put("status", "success");
        result.put("count", processed.size());
        
    } catch (exception e) {
        info "âŒ Ø®Ø·Ø£ ÙÙŠ " + module_name + ": " + e.getMessage();
        result.put("error", e.getMessage());
        result.put("status", "error");
    }
    
    return result;
}

// ============================================================================
// Ø§Ù„ØªÙ†ÙÙŠØ° Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
// ============================================================================

list modules_to_fetch = {"BTEC_Students", "Products", "BTEC_Classes", "BTEC_Enrollments"};
list all_data = list();

info "ğŸš€ Ø¨Ø¯Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø§Ù…Ù„Ø© Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¯ÙŠÙˆÙ„Ø§Øª";

for each mod in modules_to_fetch {
    all_data.add(fetchModule(mod));
    delay(500);
}

// Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒÙ„
map payload = {
    "source": "zoho_comprehensive_extractor",
    "module": "all",
    "timestamp": now,
    "total_modules": all_data.size(),
    "data": all_data
};

map headers = {"Content-Type": "application/json"};

info "ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...";
map webhook_result = invokeurl[url: WEBHOOK_URL, type: "POST", headers: headers, body: payload];

info "âœ… ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­!";
info "Ø§Ù„Ø±Ø¯: " + webhook_result.toString();

