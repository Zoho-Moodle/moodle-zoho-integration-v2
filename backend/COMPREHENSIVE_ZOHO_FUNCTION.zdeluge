// ============================================================================
// ğŸ¯ COMPREHENSIVE ZOHO DATA EXTRACTOR
// Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¨ÙŠØ§Ù†Ø§Øª Ø´Ø§Ù…Ù„Ø© Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¯ÙŠÙˆÙ„Ø§Øª Ù…Ø¹ ÙƒÙ„ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø­Ù‚ÙˆÙ„
// ============================================================================

// ============================================================================
// 1ï¸âƒ£ CONFIGURATION
// ============================================================================

// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„
string ORG_ID = "YOUR_ORG_ID";
string API_TOKEN = "YOUR_API_TOKEN";
string WEBHOOK_URL = "https://your-ngrok-url.ngrok-free.dev/v1/debug/webhook/zoho";

// Ø§Ù„Ù…ÙˆØ¯ÙŠÙˆÙ„Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù†Ù‡Ø§
list<string> MODULES = {
    "BTEC_Students",
    "Products", 
    "BTEC_Classes",
    "BTEC_Enrollments"
};

// ============================================================================
// 2ï¸âƒ£ FUNCTION: Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¬Ù…ÙŠØ¹ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø­Ù‚ÙˆÙ„
// ============================================================================

map<string, object> processFieldValue(object field_value, string field_type) {
    
    map<string, object> result = map();
    
    // Ù…Ø¹Ø§Ù„Ø¬Ø© NULL
    if (field_value == null) {
        return {"value": null, "type": field_type, "is_empty": true};
    }
    
    // 1. Ù†ØµÙˆØµ Ø¹Ø§Ø¯ÙŠØ© (Text, LongText, RichText)
    if (field_type.containsIgnoreCase("Text") || 
        field_type.containsIgnoreCase("String")) {
        return {
            "value": field_value.toString(),
            "type": "text",
            "length": field_value.toString().length()
        };
    }
    
    // 2. Ø£Ø±Ù‚Ø§Ù… (Number, Currency, Decimal)
    if (field_type.containsIgnoreCase("Number") || 
        field_type.containsIgnoreCase("Currency") ||
        field_type.containsIgnoreCase("Decimal")) {
        
        double num_value = 0.0;
        if (field_value.getDataType() == "number") {
            num_value = field_value.toNumber();
        } else {
            num_value = field_value.toString().toNumber();
        }
        
        return {
            "value": num_value,
            "type": "number",
            "is_currency": field_type.containsIgnoreCase("Currency")
        };
    }
    
    // 3. ØªÙˆØ§Ø±ÙŠØ® (Date)
    if (field_type.containsIgnoreCase("Date") && 
        !field_type.containsIgnoreCase("DateTime")) {
        
        return {
            "value": field_value.toString(),
            "type": "date",
            "format": "YYYY-MM-DD"
        };
    }
    
    // 4. ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª (DateTime, Timestamp)
    if (field_type.containsIgnoreCase("DateTime") || 
        field_type.containsIgnoreCase("Timestamp")) {
        
        return {
            "value": field_value.toString(),
            "type": "datetime",
            "format": "YYYY-MM-DD HH:mm:ss"
        };
    }
    
    // 5. Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© (Picklist, MultiSelect)
    if (field_type.containsIgnoreCase("Picklist") || 
        field_type.containsIgnoreCase("MultiSelect")) {
        
        list<string> values_list = list();
        
        // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‚ÙŠÙ…Ø© ÙˆØ§Ø­Ø¯Ø©
        if (field_value.getDataType() != "list") {
            values_list.add(field_value.toString());
        } else {
            // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‚Ø§Ø¦Ù…Ø©
            for each value in field_value {
                values_list.add(value.toString());
            }
        }
        
        return {
            "value": values_list,
            "type": "picklist",
            "is_multi_select": field_type.containsIgnoreCase("MultiSelect"),
            "count": values_list.size()
        };
    }
    
    // 6. Ø§Ù„Ø±Ø¨Ø· Ø§Ù„Ø¨Ø³ÙŠØ· (Lookup)
    if (field_type.containsIgnoreCase("Lookup")) {
        
        map<string, object> lookup_obj = map();
        
        // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª map (object)
        if (field_value.getDataType() == "map") {
            lookup_obj = field_value;
        } 
        // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª id ÙÙ‚Ø·
        else {
            lookup_obj = {
                "id": field_value.toString(),
                "name": null
            };
        }
        
        return {
            "value": lookup_obj,
            "type": "lookup",
            "has_id": lookup_obj.containKey("id"),
            "has_name": lookup_obj.containKey("name")
        };
    }
    
    // 7. Ø±Ø¨Ø· Ù…ØªØ¹Ø¯Ø¯ (Multi-Lookup)
    if (field_type.containsIgnoreCase("MultiLookup") || 
        field_type.containsIgnoreCase("Multi-Lookup")) {
        
        list<map<string, object>> lookups = list();
        
        if (field_value.getDataType() == "list") {
            for each lookup_item in field_value {
                if (lookup_item.getDataType() == "map") {
                    lookups.add(lookup_item);
                } else {
                    lookups.add({"id": lookup_item.toString(), "name": null});
                }
            }
        }
        
        return {
            "value": lookups,
            "type": "multi_lookup",
            "count": lookups.size()
        };
    }
    
    // 8. Ù…Ù†Ø·Ù‚ÙŠØ© (Boolean, Checkbox)
    if (field_type.containsIgnoreCase("Boolean") || 
        field_type.containsIgnoreCase("Checkbox")) {
        
        boolean bool_value = false;
        if (field_value.getDataType() == "boolean") {
            bool_value = field_value;
        } else {
            bool_value = field_value.toString().equalsIgnoreCase("true");
        }
        
        return {
            "value": bool_value,
            "type": "boolean"
        };
    }
    
    // 9. Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Email)
    if (field_type.containsIgnoreCase("Email")) {
        return {
            "value": field_value.toString(),
            "type": "email",
            "is_valid": field_value.toString().contains("@")
        };
    }
    
    // 10. Ù‡Ø§ØªÙ (Phone)
    if (field_type.containsIgnoreCase("Phone")) {
        return {
            "value": field_value.toString(),
            "type": "phone"
        };
    }
    
    // 11. Ù…Ø¹Ø±Ù/ID (ID)
    if (field_type.containsIgnoreCase("ID") || field_type == "id") {
        return {
            "value": field_value.toString(),
            "type": "id"
        };
    }
    
    // 12. Ù…Ù„ÙØ§Øª/Ù…Ø±ÙÙ‚Ø§Øª (File, Attachment)
    if (field_type.containsIgnoreCase("File") || 
        field_type.containsIgnoreCase("Attachment")) {
        
        list<map> files_list = list();
        if (field_value.getDataType() == "list") {
            files_list = field_value;
        }
        
        return {
            "value": files_list,
            "type": "attachment",
            "count": files_list.size()
        };
    }
    
    // 13. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© (Default/Other)
    return {
        "value": field_value,
        "type": "other",
        "data_type": field_value.getDataType()
    };
}

// ============================================================================
// 3ï¸âƒ£ FUNCTION: Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù…ÙˆØ¯ÙŠÙˆÙ„ ÙˆØ§Ø­Ø¯
// ============================================================================

map<string, object> fetchModuleData(string module_name) {
    
    info "ğŸ” Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù†: " + module_name;
    
    map<string, object> response = map();
    response.put("module", module_name);
    response.put("records", list());
    response.put("error", null);
    response.put("total_records", 0);
    
    try {
        // 1. Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù„Ù„Ù…ÙˆØ¯ÙŠÙˆÙ„
        string url = "https://www.zohoapis.com/crm/v2/" + module_name + "/metadata";
        
        map<string, string> headers = map();
        headers.put("Authorization", "Bearer " + API_TOKEN);
        headers.put("Content-Type", "application/json");
        
        map module_metadata = invokeurl
        [
            url: url,
            type: "GET",
            headers: headers
        ];
        
        list<map> fields_metadata = module_metadata.get("fields");
        info "ğŸ“‹ Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ù‚ÙˆÙ„: " + fields_metadata.size();
        
        // 2. Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
        string records_url = "https://www.zohoapis.com/crm/v2/" + module_name + 
                            "?fields=*&page=1&per_page=200";
        
        map records_response = invokeurl
        [
            url: records_url,
            type: "GET",
            headers: headers
        ];
        
        list<map> records = records_response.get("data");
        list<map> processed_records = list();
        
        info "ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø³ØªØ±Ø¬Ø¹Ø©: " + records.size();
        
        // 3. Ù…Ø¹Ø§Ù„Ø¬Ø© ÙƒÙ„ Ø³Ø¬Ù„
        for each record in records {
            
            map<string, object> processed_record = map();
            processed_record.put("id", record.get("id"));
            processed_record.put("fields_data", map());
            
            map fields_data = processed_record.get("fields_data");
            
            // Ù…Ø¹Ø§Ù„Ø¬Ø© ÙƒÙ„ Ø­Ù‚Ù„
            for each field in fields_metadata {
                
                string field_api_name = field.get("api_name");
                string field_type = field.get("data_type");
                object field_value = record.get(field_api_name);
                
                // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø­Ù‚Ù„
                map<string, object> processed_value = 
                    processFieldValue(field_value, field_type);
                
                fields_data.put(field_api_name, {
                    "label": field.get("label"),
                    "type": field_type,
                    "value": processed_value.get("value"),
                    "meta": processed_value
                });
            }
            
            processed_records.add(processed_record);
        }
        
        response.put("records", processed_records);
        response.put("total_records", processed_records.size());
        
        info "âœ… ØªÙ… Ù…Ø¹Ø§Ù„Ø¬Ø© " + processed_records.size() + " Ø³Ø¬Ù„ Ù…Ù† " + module_name;
        
    } catch (exception e) {
        info "âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† " + module_name + ": " + e.getMessage();
        response.put("error", e.getMessage());
    }
    
    return response;
}

// ============================================================================
// 4ï¸âƒ£ FUNCTION: Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ù€ Webhook
// ============================================================================

void sendToWebhook(list<map<string, object>> all_data) {
    
    try {
        
        map<string, object> payload = map();
        payload.put("source", "zoho_comprehensive");
        payload.put("module", "all_modules");
        payload.put("timestamp", now);
        payload.put("total_modules", all_data.size());
        payload.put("data", all_data);
        
        map<string, string> headers = map();
        headers.put("Content-Type", "application/json");
        headers.put("X-Zoho-Source", "comprehensive-extractor");
        
        info "ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰: " + WEBHOOK_URL;
        
        map webhook_response = invokeurl
        [
            url: WEBHOOK_URL,
            type: "POST",
            headers: headers,
            body: payload
        ];
        
        info "âœ… ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­: " + webhook_response.toString();
        
    } catch (exception e) {
        info "âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: " + e.getMessage();
    }
}

// ============================================================================
// 5ï¸âƒ£ MAIN FUNCTION: ØªÙ†ÙÙŠØ° Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ÙƒØ§Ù…Ù„Ø©
// ============================================================================

/**
 * Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø§Ù„ØªÙŠ ØªÙ‚ÙˆÙ… Ø¨Ù€:
 * 1. Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¯ÙŠÙˆÙ„Ø§Øª
 * 2. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¬Ù…ÙŠØ¹ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø­Ù‚ÙˆÙ„
 * 3. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù€ webhook
 */

list<map<string, object>> all_modules_data = list();

info "ğŸš€ Ø¨Ø¯Ø¡ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø§Ù…Ù„Ø© Ù…Ù† Zoho";
info "ğŸ“… Ø§Ù„ÙˆÙ‚Øª: " + now;
info "ğŸ”— Ø§Ù„Ù€ Webhook: " + WEBHOOK_URL;

// Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† ÙƒÙ„ Ù…ÙˆØ¯ÙŠÙˆÙ„
for each module in MODULES {
    
    info "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”";
    
    map<string, object> module_data = fetchModuleData(module);
    all_modules_data.add(module_data);
    
    // ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ· Ø¨ÙŠÙ† Ø§Ù„Ø·Ù„Ø¨Ø§Øª
    delay(1000);
}

info "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”";
info "ğŸ“¦ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙˆØ¯ÙŠÙˆÙ„Ø§Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©: " + all_modules_data.size();

// Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø©
sendToWebhook(all_modules_data);

info "âœ… Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­";

// ============================================================================
// ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ù‡Ù…Ø©
// ============================================================================

/**
 * 1ï¸âƒ£ Ù‚Ø¨Ù„ Ø§Ù„ØªØ´ØºÙŠÙ„:
 *    - Ø§Ø³ØªØ¨Ø¯Ù„ YOUR_ORG_ID Ø¨Ù€ Organization ID Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
 *    - Ø§Ø³ØªØ¨Ø¯Ù„ YOUR_API_TOKEN Ø¨Ù€ API Token Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
 *    - Ø§Ø³ØªØ¨Ø¯Ù„ URL Ø§Ù„Ù€ webhook Ø¨Ù€ URL Ø§Ù„ÙØ¹Ù„ÙŠ
 *
 * 2ï¸âƒ£ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ…Ø©:
 *    âœ… Text, LongText, RichText (Ù†ØµÙˆØµ)
 *    âœ… Number, Currency, Decimal (Ø£Ø±Ù‚Ø§Ù…)
 *    âœ… Date, DateTime (ØªÙˆØ§Ø±ÙŠØ®)
 *    âœ… Picklist, MultiSelect (Ù‚ÙˆØ§Ø¦Ù…)
 *    âœ… Lookup, Multi-Lookup (Ø±ÙˆØ§Ø¨Ø·)
 *    âœ… Boolean, Checkbox (Ù…Ù†Ø·Ù‚ÙŠØ©)
 *    âœ… Email, Phone (Ø¨Ø±ÙŠØ¯ ÙˆÙ‡Ø§ØªÙ)
 *    âœ… File, Attachment (Ù…Ù„ÙØ§Øª)
 *    âœ… ID (Ù…Ø¹Ø±ÙØ§Øª)
 *
 * 3ï¸âƒ£ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø±Ø³Ù„Ø©:
 *    - Ù„ÙƒÙ„ Ø­Ù‚Ù„: Ø§Ù„Ù‚ÙŠÙ…Ø©ØŒ Ø§Ù„Ù†ÙˆØ¹ØŒ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØµÙÙŠØ©
 *    - Ù…Ø¹Ø§Ù„Ø¬Ø© Ø®Ø§ØµØ© Ù„ÙƒÙ„ Ù†ÙˆØ¹ Ø­Ù‚Ù„
 *    - Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© (Ù…Ø«Ù„ Ø¹Ø¯Ø¯ Ø§Ù„Ø¢ÙŠØªÙ…Ø§ØªØŒ Ø§Ù„ØµØ­Ø©ØŒ Ø¥Ù„Ø®)
 *
 * 4ï¸âƒ£ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡:
 *    - Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ù„ÙƒÙ„ Ù…ÙˆØ¯ÙŠÙˆÙ„
 *    - ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø¨Ø¯ÙˆÙ† ØªÙˆÙ‚Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
 *    - Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© Ø­ØªÙ‰ Ù…Ø¹ ÙˆØ¬ÙˆØ¯ Ø£Ø®Ø·Ø§Ø¡
 *
 * 5ï¸âƒ£ Ø§Ù„Ø£Ø¯Ø§Ø¡:
 *    - ØªØ£Ø®ÙŠØ± 1 Ø«Ø§Ù†ÙŠØ© Ø¨ÙŠÙ† Ø§Ù„Ø·Ù„Ø¨Ø§Øª (ØªØ¬Ù†Ø¨ Ø§Ù„Ø­Ø¯ Ù…Ù† Ø§Ù„Ù…Ø¹Ø¯Ù„)
 *    - ÙŠØ¯Ø¹Ù… Ø­ØªÙ‰ 200 Ø³Ø¬Ù„ Ù„ÙƒÙ„ Ù…ÙˆØ¯ÙŠÙˆÙ„
 *    - Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ø³Ø¬Ù„Ø§ØªØŒ Ø§Ø·Ù„Ø¨ ØµÙØ­Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
 */

