{% extends "base.html" %}
{% block title %}Sync Control{% endblock %}
{% block page_title %}Sync Control{% endblock %}
{% block page_subtitle_text %}Trigger and monitor Zoho → Moodle full sync{% endblock %}

{% block content %}

<!-- Main grid -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-5">

  <!-- LEFT: Trigger panel -->
  <div class="space-y-5">

    <!-- Full Sync -->
    <div class="card">
      <h2 class="text-sm font-semibold text-gray-800 mb-1">Full Sync (7 Steps)</h2>
      <p class="text-xs text-gray-400 mb-4">Syncs all data from Zoho → Moodle in dependency order.</p>

      <div class="mb-4 space-y-1 text-xs text-gray-500">
        <p class="flex items-center gap-1.5"><span class="h-1.5 w-1.5 rounded-full bg-brand-500"></span>Step 1: Students</p>
        <p class="flex items-center gap-1.5"><span class="h-1.5 w-1.5 rounded-full bg-brand-500"></span>Step 2: Classes</p>
        <p class="flex items-center gap-1.5"><span class="h-1.5 w-1.5 rounded-full bg-brand-500"></span>Step 3: Registrations</p>
        <p class="flex items-center gap-1.5"><span class="h-1.5 w-1.5 rounded-full bg-brand-500"></span>Step 4: Enrollments</p>
        <p class="flex items-center gap-1.5"><span class="h-1.5 w-1.5 rounded-full bg-brand-500"></span>Step 5: Payments</p>
        <p class="flex items-center gap-1.5"><span class="h-1.5 w-1.5 rounded-full bg-brand-500"></span>Step 6: Grades</p>
        <p class="flex items-center gap-1.5"><span class="h-1.5 w-1.5 rounded-full bg-brand-500"></span>Step 7: Requests</p>
      </div>

      <form hx-post="/admin/sync/start"
            hx-target="#sync-status-panel"
            hx-swap="innerHTML"
            hx-indicator="#sync-spinner">
        <button type="submit" class="btn-primary w-full justify-center">
          <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
          </svg>
          <span id="sync-spinner" class="htmx-indicator">⟳</span>
          Start Full Sync
        </button>
      </form>
    </div>

    <!-- Single Student Sync -->
    <div class="card">
      <h2 class="text-sm font-semibold text-gray-800 mb-1">Sync Single Student</h2>
      <p class="text-xs text-gray-400 mb-4">Fetches one student + their related data from Zoho.</p>

      <form hx-post="/admin/sync/single-student"
            hx-target="#single-result"
            hx-swap="innerHTML"
            class="space-y-3">
        <input type="text" name="zoho_student_id" required
               placeholder="Zoho Student Record ID"
               class="input-field" />
        <button type="submit" class="btn-secondary w-full justify-center">
          Sync Student
        </button>
      </form>
      <div id="single-result" class="mt-3"></div>
    </div>

  </div>

  <!-- RIGHT: Live status panel (2 cols) -->
  <div class="lg:col-span-2">
    <div class="card">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-sm font-semibold text-gray-800">Live Sync Status</h2>
        <div id="poll-indicator" class="flex items-center gap-1.5 text-xs text-gray-400">
          <span class="h-2 w-2 rounded-full bg-gray-300 animate-pulse" id="poll-dot"></span>
          <span id="poll-label">Polling every 3s</span>
        </div>
      </div>

      <!-- This div is replaced by HTMX polling -->
      <div id="sync-status-panel"
           hx-get="/admin/sync/status-partial"
           hx-trigger="every 3s"
           hx-swap="innerHTML">
        {% include "partials/sync_status.html" %}
      </div>
    </div>
  </div>

</div>

{% endblock %}

{% block extra_scripts %}
<script>
  // Update poll dot color based on sync status
  document.body.addEventListener('htmx:afterSwap', function(e) {
    if (e.target.id === 'sync-status-panel') {
      const dot = document.getElementById('poll-dot');
      const status = document.querySelector('[data-sync-status]');
      if (status) {
        const s = status.dataset.syncStatus;
        dot.className = 'h-2 w-2 rounded-full ' + (
          s === 'running'   ? 'bg-blue-400 animate-pulse' :
          s === 'completed' ? 'bg-green-400' :
          s === 'failed'    ? 'bg-red-400' : 'bg-gray-300 animate-pulse'
        );
      }
    }
  });
</script>
{% endblock %}
