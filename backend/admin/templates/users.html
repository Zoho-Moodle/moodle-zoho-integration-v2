{% extends "base.html" %}
{% block title %}Users{% endblock %}
{% block page_title %}User Management{% endblock %}
{% block page_subtitle_text %}Manage admin panel accounts and roles{% endblock %}

{% block content %}

<!-- Flash messages -->
{% if msg %}
<div class="mb-4 flex items-center gap-2 px-4 py-2.5 rounded-xl bg-green-50 border border-green-200 text-green-700 text-sm">
  <svg class="w-4 h-4 shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
  </svg>
  {{ msg }}
</div>
{% endif %}
{% if error %}
<div class="mb-4 flex items-center gap-2 px-4 py-2.5 rounded-xl bg-red-50 border border-red-200 text-red-700 text-sm">
  <svg class="w-4 h-4 shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
  </svg>
  {{ error }}
</div>
{% endif %}

<div class="grid grid-cols-1 lg:grid-cols-5 gap-5">

  <!-- Existing users (3 cols) -->
  <div class="lg:col-span-3">
    <div class="card p-0 overflow-hidden">
      <div class="px-5 py-3 border-b border-gray-100 bg-gray-50">
        <h2 class="text-sm font-semibold text-gray-800">Admin Panel Users</h2>
      </div>

      <table class="w-full">
        <thead>
          <tr>
            <th class="table-th">User</th>
            <th class="table-th">Role</th>
            <th class="table-th">Created</th>
            <th class="table-th">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for u in users %}
          <tr class="hover:bg-gray-50 transition-colors" x-data="{ showPwForm: false }">
            <td class="table-td">
              <div class="flex items-center gap-2.5">
                <div class="h-8 w-8 rounded-full bg-brand-100 flex items-center justify-center text-brand-700 font-semibold text-sm shrink-0">
                  {{ u.full_name[0].upper() if u.full_name else '?' }}
                </div>
                <div>
                  <p class="text-sm font-medium text-gray-800">{{ u.full_name }}</p>
                  <p class="text-xs text-gray-400 font-mono">@{{ u.username }}</p>
                </div>
              </div>
            </td>
            <td class="table-td">
              {% if u.role == 'admin' %}
                <span class="badge-info">Admin</span>
              {% elif u.role == 'operator' %}
                <span class="badge-warn">Operator</span>
              {% else %}
                <span class="badge-gray">{{ u.role }}</span>
              {% endif %}
            </td>
            <td class="table-td text-xs text-gray-400">
              {% if u.created_at %}{{ ts(u.created_at) }}{% else %}—{% endif %}
            </td>
            <td class="table-td">
              <div class="flex items-center gap-2">
                <!-- Change password toggle -->
                <button @click="showPwForm = !showPwForm"
                        class="text-xs text-brand-600 hover:underline font-medium">
                  ≡ Password
                </button>

                {% if u.username != user.username %}
                <form action="/admin/users/delete/{{ u.username }}" method="post"
                      onsubmit="return confirm('Delete user {{ u.full_name }}?')">
                  <button type="submit" class="text-xs text-red-500 hover:underline font-medium">✕ Delete</button>
                </form>
                {% else %}
                <span class="text-xs text-gray-300">(you)</span>
                {% endif %}
              </div>

              <!-- Change password inline form -->
              <div x-show="showPwForm" x-cloak class="mt-2">
                <form action="/admin/users/change-password" method="post" class="flex gap-2">
                  <input type="hidden" name="target_username" value="{{ u.username }}" />
                  <input type="password" name="new_password" required minlength="6"
                         placeholder="New password"
                         class="input-field text-xs py-1" />
                  <button type="submit" class="btn-primary text-xs py-1 px-3 shrink-0">Save</button>
                </form>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Create user form (2 cols) -->
  <div class="lg:col-span-2">
    <div class="card">
      <h2 class="text-sm font-semibold text-gray-800 mb-4">Create New User</h2>

      <form action="/admin/users/create" method="post" class="space-y-4">
        <div>
          <label class="block text-xs font-medium text-gray-700 mb-1">Full Name</label>
          <input type="text" name="new_full_name" required
                 class="input-field" placeholder="John Smith" />
        </div>
        <div>
          <label class="block text-xs font-medium text-gray-700 mb-1">Username</label>
          <input type="text" name="new_username" required
                 class="input-field" placeholder="jsmith" pattern="[a-zA-Z0-9_\-]+" />
          <p class="text-xs text-gray-400 mt-1">Letters, numbers, underscore, hyphen only</p>
        </div>
        <div>
          <label class="block text-xs font-medium text-gray-700 mb-1">Password</label>
          <input type="password" name="new_password" required minlength="6"
                 class="input-field" placeholder="Minimum 6 characters" />
        </div>
        <div>
          <label class="block text-xs font-medium text-gray-700 mb-1">Role</label>
          <select name="new_role" class="input-field">
            <option value="operator">Operator — Can view data and trigger syncs, cannot edit settings</option>
            <option value="admin">Admin — Full access including settings and user management</option>
          </select>
        </div>
        <button type="submit" class="btn-primary w-full justify-center">
          Create User
        </button>
      </form>

      <!-- Role descriptions -->
      <div class="mt-5 pt-4 border-t border-gray-100 space-y-2">
        <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Role Permissions</p>
        <div class="text-xs text-gray-500 space-y-1.5">
          <div class="flex items-start gap-2">
            <span class="badge-info shrink-0">Admin</span>
            <span>Full access: Dashboard, Sync, Logs, Data, Settings, Users</span>
          </div>
          <div class="flex items-start gap-2">
            <span class="badge-warn shrink-0">Operator</span>
            <span>Can view all pages, trigger syncs and single-student sync. Cannot edit Settings or manage Users.</span>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>
{% endblock %}
