{% extends "base.html" %}

{% block title %}Field Mappings{% endblock %}
{% block page_title %}Field Mappings{% endblock %}
{% block page_subtitle_text %}View and edit the Zoho module assignments and field mappings for each data entity.{% endblock %}

{% block content %}
<div x-data="mappingsPage()" x-init="init()" class="space-y-6">

  <!-- Header actions -->
  <div class="flex items-center justify-between">
    <div class="flex items-center gap-2">
      <span class="text-xs text-gray-500">Tenant:</span>
      <span class="badge-info text-xs">default</span>
      <span x-show="lastSaved" class="text-xs text-green-600 font-medium" x-text="lastSaved"></span>
    </div>
    <div class="flex items-center gap-2">
      <button @click="loadAll()" class="btn-secondary text-xs flex items-center gap-1.5" :disabled="loading">
        <svg x-show="loading" class="w-3.5 h-3.5 animate-spin" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
        </svg>
        <svg x-show="!loading" class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
        </svg>
        Refresh
      </button>
      <a href="/admin/setup#step5" class="btn-primary text-xs">
        ‚öô Re-run Setup Wizard Step 5
      </a>
    </div>
  </div>

  <!-- Info banner -->
  <div class="bg-blue-50 border border-blue-100 rounded-xl px-4 py-3 text-xs text-blue-700 flex items-start gap-2">
    <svg class="w-4 h-4 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
    </svg>
    <span>
      These mappings tell the system which Zoho fields map to which local database columns.
      Changes here take effect immediately ‚Äî all webhook processing and sync operations will use the updated mappings.
      <a href="/admin/setup" class="underline font-medium ml-1">Re-run the Setup Wizard</a> to rediscover fields from Zoho.
    </span>
  </div>

  <!-- Loading state -->
  <div x-show="loading && !entities.length" class="card text-center py-12 text-gray-400 text-sm">
    Loading mappings‚Ä¶
  </div>

  <!-- Error state -->
  <template x-if="loadError">
    <div class="card bg-red-50 border-red-200 text-red-700 text-sm px-4 py-3" x-text="loadError"></div>
  </template>

  <!-- Entity cards -->
  <template x-for="(entity, ei) in entities" :key="entity.id">
    <div class="card space-y-4">

      <!-- Card header -->
      <div class="flex items-start gap-3">
        <div class="h-9 w-9 rounded-xl flex items-center justify-center flex-shrink-0"
             :class="entity.zohoModule ? 'bg-green-50' : 'bg-gray-100'">
          <svg class="w-4.5 h-4.5" :class="entity.zohoModule ? 'text-green-600' : 'text-gray-400'"
               fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 21L3 16.5m0 0L7.5 12M3 16.5h13.5m0-13.5L21 7.5m0 0L16.5 12M21 7.5H7.5"/>
          </svg>
        </div>

        <div class="flex-1 min-w-0">
          <div class="flex items-center gap-2 flex-wrap">
            <h3 class="text-sm font-bold text-gray-900" x-text="entity.label"></h3>
            <template x-if="entity.zohoModule">
              <span class="badge-success text-xs font-mono" x-text="entity.zohoModule"></span>
            </template>
            <template x-if="!entity.zohoModule">
              <span class="badge-warn text-xs">‚ö† No module assigned</span>
            </template>
            <span class="badge-gray text-xs" x-text="mappingCount(entity) + ' fields mapped'"></span>
          </div>
          <p class="text-xs text-gray-500 mt-0.5" x-text="entity.description"></p>
        </div>

        <!-- Expand/collapse + actions -->
        <div class="flex items-center gap-2 flex-shrink-0">
          <button @click="clearMapping(entity)"
                  x-show="entity.zohoModule || mappingCount(entity) > 0"
                  class="text-xs text-red-500 hover:text-red-700 px-2 py-1 rounded hover:bg-red-50 transition-colors">
            Clear
          </button>
          <button @click="entity.expanded = !entity.expanded"
                  class="btn-secondary text-xs">
            <svg class="w-3.5 h-3.5 transition-transform" :class="entity.expanded ? 'rotate-180' : ''"
                 fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/>
            </svg>
            <span x-text="entity.expanded ? 'Collapse' : 'Edit Mapping'"></span>
          </button>
        </div>
      </div>

      <!-- Quick view: current mappings (collapsed) -->
      <template x-if="!entity.expanded && mappingCount(entity) > 0">
        <div class="flex flex-wrap gap-1.5">
          <template x-for="cf in entity.canonicalFields" :key="cf.key">
            <template x-if="entity.fieldMap[cf.key]">
              <span class="text-xs bg-gray-50 border border-gray-100 rounded-lg px-2 py-0.5 font-mono text-gray-600">
                <span class="text-indigo-600" x-text="cf.key"></span>
                <span class="text-gray-400 mx-1">‚Üí</span>
                <span x-text="entity.fieldMap[cf.key]"></span>
              </span>
            </template>
          </template>
        </div>
      </template>

      <!-- Empty state (collapsed) -->
      <template x-if="!entity.expanded && mappingCount(entity) === 0">
        <p class="text-xs text-amber-600 bg-amber-50 border border-amber-100 rounded-lg px-3 py-2">
          No field mappings saved yet. Click <strong>Edit Mapping</strong> to configure.
        </p>
      </template>

      <!-- Expanded editor -->
      <div x-show="entity.expanded" class="border-t border-gray-100 pt-4 space-y-4">

        <!-- Module selector + discover fields -->
        <div class="flex items-center gap-3 flex-wrap">
          <div class="flex-1 min-w-0">
            <label class="block text-xs font-medium text-gray-600 mb-1">Zoho Module</label>
            <div class="flex items-center gap-2">
              <template x-if="zohoModules.length > 0">
                <select x-model="entity.zohoModule"
                        @change="entity.zohoFields = []; entity.zohoFieldsLoaded = false"
                        class="text-xs border border-gray-200 rounded-lg px-2 py-1.5 bg-white text-gray-700 focus:outline-none focus:ring-2 focus:ring-brand-500 w-72">
                  <option value="">‚Äî Select Zoho Module ‚Äî</option>
                  <template x-for="mod in zohoModules" :key="mod.api_name">
                    <option :value="mod.api_name" x-text="mod.label + ' (' + mod.api_name + ')'"></option>
                  </template>
                </select>
              </template>
              <template x-if="zohoModules.length === 0">
                <input x-model="entity.zohoModule" type="text" placeholder="e.g. BTEC_Students"
                       class="input-field text-xs w-64"/>
              </template>

              <button @click="discoverFields(entity)"
                      x-show="entity.zohoModule"
                      class="btn-secondary text-xs flex items-center gap-1.5"
                      :disabled="entity.fieldsLoading">
                <svg x-show="entity.fieldsLoading" class="w-3 h-3 animate-spin" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
                </svg>
                üîç Get Fields from Zoho
              </button>

              <template x-if="!entity.fieldsLoading && entity.zohoFieldsLoaded">
                <span class="text-xs text-green-600">‚úì <span x-text="entity.zohoFields.length"></span> fields loaded</span>
              </template>
            </div>
          </div>
        </div>

        <!-- Field mapping table -->
        <template x-if="entity.canonicalFields.length > 0">
          <div>
            <label class="block text-xs font-medium text-gray-600 mb-2">Field Mapping ‚Äî Local DB ‚Üî Zoho</label>
            <div class="bg-white border border-gray-100 rounded-xl overflow-hidden">
              <table class="w-full text-xs">
                <thead class="bg-gray-50 border-b border-gray-100">
                  <tr>
                    <th class="table-th w-2/5">Local DB Column</th>
                    <th class="table-th">Zoho API Field</th>
                    <th class="table-th w-16 text-center">Status</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-gray-50">
                  <template x-for="cf in entity.canonicalFields" :key="cf.key">
                    <tr class="hover:bg-gray-50/50 transition-colors">
                      <td class="table-td">
                        <code class="text-indigo-700 font-semibold" x-text="cf.key"></code>
                        <span class="text-gray-400 block text-xs mt-0.5" x-text="cf.label"></span>
                      </td>
                      <td class="table-td">
                        <!-- Dropdown if fields loaded, text input otherwise -->
                        <template x-if="entity.zohoFields.length > 0">
                          <select x-model="entity.fieldMap[cf.key]"
                                  class="w-full text-xs border border-gray-200 rounded-lg px-2 py-1 bg-white focus:outline-none focus:ring-1 focus:ring-indigo-400">
                            <option value="">‚Äî skip / not mapped ‚Äî</option>
                            <template x-for="zf in entity.zohoFields" :key="zf.api_name">
                              <option :value="zf.api_name" x-text="zf.label + ' (' + zf.api_name + ')'"></option>
                            </template>
                          </select>
                        </template>
                        <template x-if="entity.zohoFields.length === 0">
                          <input x-model="entity.fieldMap[cf.key]" type="text"
                                 :placeholder="cf.key"
                                 class="w-full text-xs border border-gray-200 rounded-lg px-2 py-1 focus:outline-none focus:ring-1 focus:ring-indigo-400"/>
                        </template>
                      </td>
                      <td class="table-td text-center">
                        <template x-if="entity.fieldMap[cf.key]">
                          <span class="text-green-500">‚úì</span>
                        </template>
                        <template x-if="!entity.fieldMap[cf.key]">
                          <span class="text-gray-300">‚Äî</span>
                        </template>
                      </td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>
          </div>
        </template>

        <!-- Save / error -->
        <div class="flex items-center justify-between pt-1">
          <template x-if="entity.saveError">
            <p class="text-xs text-red-500" x-text="entity.saveError"></p>
          </template>
          <div x-show="!entity.saveError"></div>
          <button @click="saveMapping(entity)"
                  class="btn-primary text-xs flex items-center gap-1.5"
                  :disabled="entity.saving || !entity.zohoModule">
            <svg x-show="entity.saving" class="w-3.5 h-3.5 animate-spin" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
            </svg>
            üíæ Save Mapping
          </button>
        </div>
      </div>

    </div>
  </template>

</div>
{% endblock %}

{% block extra_head %}
<script>
function mappingsPage() {
  return {
    loading: false,
    loadError: null,
    lastSaved: null,
    zohoModules: [],

    entities: [
      { id: 'students', label: 'Students', description: 'Student profile data (Zoho ‚Üí local DB).', expanded: false, zohoModule: '', zohoFields: [], zohoFieldsLoaded: false, fieldsLoading: false, fieldMap: {}, saving: false, saveError: null,
        canonicalFields: [
          { key: 'student_id',     label: 'Student ID / Name' },
          { key: 'first_name',     label: 'First Name' },
          { key: 'last_name',      label: 'Last Name' },
          { key: 'display_name',   label: 'Display Name' },
          { key: 'email',          label: 'Academic Email' },
          { key: 'phone_number',   label: 'Phone Number' },
          { key: 'status',         label: 'Status' },
          { key: 'moodle_user_id', label: 'Moodle User ID' },
          { key: 'national_id',    label: 'National ID' },
          { key: 'major',          label: 'Major' },
          { key: 'gender',         label: 'Gender' },
          { key: 'nationality',    label: 'Nationality' },
          { key: 'date_of_birth',  label: 'Date of Birth' },
          { key: 'address',        label: 'Address' },
          { key: 'city',           label: 'City' },
        ],
      },
      { id: 'registrations', label: 'Registrations', description: 'Academic enrollment registrations.', expanded: false, zohoModule: '', zohoFields: [], zohoFieldsLoaded: false, fieldsLoading: false, fieldMap: {}, saving: false, saveError: null,
        canonicalFields: [
          { key: 'registration_number',      label: 'Registration Number' },
          { key: 'registration_date',        label: 'Registration Date' },
          { key: 'registration_status',      label: 'Status' },
          { key: 'program_name',             label: 'Program Name' },
          { key: 'total_fees',               label: 'Total Fees' },
          { key: 'paid_amount',              label: 'Paid Amount' },
          { key: 'remaining_amount',         label: 'Remaining Amount' },
          { key: 'study_mode',               label: 'Study Mode' },
          { key: 'expected_graduation',      label: 'Expected Graduation' },
          { key: 'number_of_installments',   label: 'Number of Installments' },
        ],
      },
      { id: 'classes', label: 'Classes', description: 'Zoho classes ‚Üí Moodle courses.', expanded: false, zohoModule: '', zohoFields: [], zohoFieldsLoaded: false, fieldsLoading: false, fieldMap: {}, saving: false, saveError: null,
        canonicalFields: [
          { key: 'class_name',       label: 'Class Name' },
          { key: 'class_short_name', label: 'Short Name' },
          { key: 'program_name',     label: 'Program Name' },
          { key: 'unit_name',        label: 'Unit Name' },
          { key: 'teacher_name',     label: 'Teacher Name' },
          { key: 'moodle_class_id',  label: 'Moodle Course ID' },
          { key: 'class_status',     label: 'Status' },
          { key: 'start_date',       label: 'Start Date' },
          { key: 'class_major',      label: 'Class Major' },
        ],
      },
      { id: 'enrollments', label: 'Enrollments', description: 'Student ‚Üí class enrollment records.', expanded: false, zohoModule: '', zohoFields: [], zohoFieldsLoaded: false, fieldsLoading: false, fieldMap: {}, saving: false, saveError: null,
        canonicalFields: [
          { key: 'enrollment_status',  label: 'Enrollment Status' },
          { key: 'enrollment_date',    label: 'Enrollment Date' },
          { key: 'final_grade',        label: 'Final Grade' },
          { key: 'final_grade_letter', label: 'Grade Letter' },
          { key: 'pass_fail',          label: 'Pass / Fail' },
        ],
      },
      { id: 'grades', label: 'Grades', description: 'Assessment and grade records.', expanded: false, zohoModule: '', zohoFields: [], zohoFieldsLoaded: false, fieldsLoading: false, fieldMap: {}, saving: false, saveError: null,
        canonicalFields: [
          { key: 'unit_name',          label: 'Unit / Assessment Name' },
          { key: 'final_grade',        label: 'Final Grade (numeric)' },
          { key: 'final_grade_letter', label: 'Grade Letter' },
          { key: 'pass_fail',          label: 'Pass / Fail' },
          { key: 'assessment_date',    label: 'Assessment Date' },
        ],
      },
      { id: 'payments', label: 'Payments', description: 'Fee payment and receipt records.', expanded: false, zohoModule: '', zohoFields: [], zohoFieldsLoaded: false, fieldsLoading: false, fieldMap: {}, saving: false, saveError: null,
        canonicalFields: [
          { key: 'payment_number', label: 'Payment Number' },
          { key: 'payment_amount', label: 'Amount' },
          { key: 'payment_date',   label: 'Payment Date' },
          { key: 'payment_method', label: 'Method' },
          { key: 'payment_status', label: 'Status' },
          { key: 'voucher_number', label: 'Voucher Number' },
          { key: 'receipt_number', label: 'Receipt Number' },
          { key: 'bank_name',      label: 'Bank Name' },
          { key: 'payment_notes',  label: 'Notes' },
        ],
      },
      { id: 'student_requests', label: 'Student Requests', description: 'Student support and change requests.', expanded: false, zohoModule: '', zohoFields: [], zohoFieldsLoaded: false, fieldsLoading: false, fieldMap: {}, saving: false, saveError: null,
        canonicalFields: [
          { key: 'request_type',        label: 'Request Type' },
          { key: 'request_status',      label: 'Status' },
          { key: 'request_description', label: 'Description' },
          { key: 'student_name',        label: 'Student Name' },
          { key: 'academic_email',      label: 'Academic Email' },
        ],
      },
    ],

    async init() {
      await Promise.all([this.loadAll(), this.loadZohoModules()]);
    },

    async loadAll() {
      this.loading = true;
      this.loadError = null;
      try {
        const r = await fetch('/admin/setup/load-field-mappings');
        const data = await r.json();
        if (!data.ok) { this.loadError = data.error; return; }
        for (const entity of this.entities) {
          const saved = data.data[entity.id];
          if (saved) {
            entity.zohoModule = saved.zoho_module || '';
            entity.fieldMap   = saved.mappings    || {};
          }
        }
      } catch (e) {
        this.loadError = e.message;
      }
      this.loading = false;
    },

    async loadZohoModules() {
      try {
        const r = await fetch('/admin/setup/zoho-modules');
        const data = await r.json();
        if (data.ok) this.zohoModules = data.modules;
      } catch (e) {
        // silently fail ‚Äî user can type module name manually
      }
    },

    async discoverFields(entity) {
      if (!entity.zohoModule) return;
      entity.fieldsLoading = true;
      entity.saveError = null;
      try {
        const r = await fetch(`/admin/setup/zoho-fields?module=${encodeURIComponent(entity.zohoModule)}`);
        const data = await r.json();
        if (data.ok) {
          entity.zohoFields = data.fields;
          entity.zohoFieldsLoaded = true;
          // Auto-match unmapped fields
          for (const cf of entity.canonicalFields) {
            if (entity.fieldMap[cf.key]) continue;
            const guess = entity.zohoFields.find(zf =>
              zf.api_name.toLowerCase() === cf.key.toLowerCase() ||
              zf.api_name.toLowerCase().replace(/_/g,'') === cf.key.toLowerCase().replace(/_/g,'')
            );
            if (guess) entity.fieldMap[cf.key] = guess.api_name;
          }
        } else {
          entity.saveError = data.error || 'Failed to load fields';
        }
      } catch (e) {
        entity.saveError = e.message;
      }
      entity.fieldsLoading = false;
    },

    async saveMapping(entity) {
      if (!entity.zohoModule) return;
      entity.saving = true;
      entity.saveError = null;
      try {
        const r = await fetch('/admin/setup/save-field-mapping', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            service: entity.id,
            zoho_module: entity.zohoModule,
            mappings: entity.fieldMap,
          }),
        });
        const data = await r.json();
        if (data.ok) {
          entity.expanded = false;
          const now = new Date();
          this.lastSaved = `‚úì ${entity.label} saved at ${now.toLocaleTimeString()}`;
        } else {
          entity.saveError = data.error;
        }
      } catch (e) {
        entity.saveError = e.message;
      }
      entity.saving = false;
    },

    async clearMapping(entity) {
      if (!confirm(`Clear all field mappings for ${entity.label}?`)) return;
      try {
        await fetch('/admin/mappings/clear', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ service: entity.id }),
        });
        entity.zohoModule = '';
        entity.fieldMap = {};
        entity.zohoFields = [];
        entity.zohoFieldsLoaded = false;
        this.lastSaved = `‚úì ${entity.label} mapping cleared`;
      } catch (e) {
        console.error(e);
      }
    },

    mappingCount(entity) {
      return Object.values(entity.fieldMap).filter(v => v).length;
    },
  };
}
</script>
{% endblock %}
